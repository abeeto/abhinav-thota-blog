---
layout: base.njk
---

<section class="wrapper flow section markdown-blog-content" data-padding="wide" >
    <h1>{{ title }}</h1>
    {{ content | safe }}
</section>

{% if comments %}
    <section class="section comment-section" data-post-slug="{{ slug }}" x-data="commentSection" x-init="init()" data-padding="wide">
        <div class="wrapper flow" data-flow-margin="compact">
            <h2>Leave a comment</h2>        
            <!-- Comment form - always visible but disabled when not authenticated -->
            <form @submit.prevent="postComment">
                <textarea class="comment-textarea" x-model="content" placeholder="Your comment" required x-bind:disabled="!isAuthenticated || posting"></textarea>
                <button class="comment-form-btn" x-show="!isAuthenticated" type="button" @click="handleSignIn()" data-button-type="accent" x-bind:disabled="signingIn" x-text="signingIn ? 'Signing In...' : 'Sign In to Comment'"></button>
                <button class="comment-form-btn" x-show="isAuthenticated" type="submit" data-button-type="accent" x-bind:disabled="posting" x-text="posting ? 'Posting...' : 'Post Comment'"></button>
            </form>
            <!-- Auth status display -->
            <div x-show="isAuthenticated" style="display: none;">
                <p>Signed in as <strong x-text="currentUser?.profile?.name || currentUser?.profile?.email"></strong></p>
                <button type="button" @click="handleSignOut()" data-button-type="muted">Sign Out</button>
            </div>
        </div>
        <div class = "wrapper flow">
            <div x-show="loadingComments">Loading comments...</div>
            <template x-for="comment in comments" :key="comment.commentId">
                <div class="comment">
                    <div class="comment-meta">
                        <strong x-text="comment.userName"></strong>
                        <strong x-text="formatDate(comment.createdAt)"></strong>
                    </div>
                    <div class="comment-content">
                        <p x-text="comment.content"></p>
                    </div>
                    <button type="button" data-button-type="muted" x-show="isAuthenticated && comment.userId === currentUser?.profile?.sub"  @click="deleteComment(comment.commentId)" x-bind:disabled="deletingId === comment.commentId" x-text="deletingId === comment.commentId ? 'Deleting...' : 'Delete'"></button>
                </div>
            </template>
        </div>
    </section>
{% endif %}